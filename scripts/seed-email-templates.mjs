#!/usr/bin/env node

/**
 * Seed email templates from local database into production.
 *
 * Usage:
 *   node scripts/seed-email-templates.mjs              # dry-run (default)
 *   node scripts/seed-email-templates.mjs --apply      # actually insert into production
 */

import postgres from 'postgres'

const LOCAL_URL = 'postgresql://postgres:postgres@127.0.0.1:54322/postgres'
const PROD_URL = process.env.PROD_DATABASE_URL

if (!PROD_URL) {
  console.error('Missing PROD_DATABASE_URL. Set it in .env.local or as an env var.')
  process.exit(1)
}

const dryRun = !process.argv.includes('--apply')

async function main() {
  const local = postgres(LOCAL_URL)
  const prod = postgres(PROD_URL)

  try {
    // 1. Fetch all active templates from local
    const localTemplates = await local`
      SELECT id, name, category, subject, body_html, body_text, is_default, created_by
      FROM email_templates
      WHERE deleted_at IS NULL
      ORDER BY category, name
    `

    console.log(`Found ${localTemplates.length} local templates:\n`)
    for (const t of localTemplates) {
      console.log(`  [${t.category}] ${t.name}${t.is_default ? ' (default)' : ''}`)
    }

    // 2. Check what already exists in production
    const prodTemplates = await prod`
      SELECT id, name, category FROM email_templates WHERE deleted_at IS NULL
    `

    const existingKeys = new Set(
      prodTemplates.map(t => `${t.category}::${t.name}`)
    )

    const toInsert = localTemplates.filter(
      t => !existingKeys.has(`${t.category}::${t.name}`)
    )

    const skipped = localTemplates.length - toInsert.length

    if (skipped > 0) {
      console.log(`\nSkipping ${skipped} template(s) that already exist in production.`)
    }

    if (toInsert.length === 0) {
      console.log('\nNothing to insert. Production is up to date.')
      return
    }

    console.log(`\n${toInsert.length} template(s) to insert:`)
    for (const t of toInsert) {
      console.log(`  + [${t.category}] ${t.name}`)
    }

    if (dryRun) {
      console.log('\n--- DRY RUN --- Pass --apply to actually insert into production.')
      return
    }

    // 3. Insert into production (new UUIDs generated by DB default)
    const now = new Date().toISOString()
    const rows = toInsert.map(t => ({
      name: t.name,
      category: t.category,
      subject: t.subject,
      body_html: t.body_html,
      body_text: t.body_text,
      is_default: t.is_default,
      created_by: null,
      created_at: now,
      updated_at: now,
    }))

    await prod`
      INSERT INTO email_templates ${prod(rows, 'name', 'category', 'subject', 'body_html', 'body_text', 'is_default', 'created_by', 'created_at', 'updated_at')}
    `

    console.log(`\nInserted ${toInsert.length} template(s) into production.`)

  } finally {
    await local.end()
    await prod.end()
  }
}

main().catch(err => {
  console.error('Seed failed:', err.message)
  process.exit(1)
})
